# 3D绘图板 - 高级拾取系统功能说明 (OSG 3.6.5完整版)

## 概述

本项目现已集成了一个完整的64位ID拾取系统，基于OSG 3.6.5全功能API，支持面、边、点的精确拾取和实时指示。

## 主要功能

### 1. 64位ID编码系统
- **对象ID**: 40位 (支持1万亿个对象)
- **类型代码**: 2位 (面=00, 边=01, 点=10)
- **本地索引**: 22位 (支持400万个Feature)

### 2. 多级Feature抽取
- **面Feature**: 从三角剖分网格中提取每个三角面
- **边Feature**: 从三角面中提取非重复边线
- **点Feature**: 提取所有顶点

### 3. 高级拾取渲染
- **3遍渲染**: 分别渲染面、边、点，确保Feature层次可见
- **专用拾取相机**: 独立的FBO渲染管线
- **多像素采样**: 自适应采样策略，提升拾取精度

### 4. 智能指示器系统
- **顶点指示器**: 红色方框，带缩放动画
- **边指示器**: 绿色三角箭头，带脉冲动画  
- **面指示器**: 蓝色圆环，带旋转动画
- **对象高亮**: 黄色线框高亮显示整个对象

### 5. 实时交互
- **鼠标悬停**: 实时显示拾取结果
- **频率限制**: 60Hz拾取频率，性能优化
- **坐标重建**: 精确的屏幕到世界坐标转换

## 使用方法

### 启动测试
1. 编译并运行应用程序
2. 点击 "文件" → "新建" 或 Ctrl+N
3. 系统会自动添加一个测试立方体
4. 移动鼠标到立方体上方

### 拾取体验
- **面拾取**: 鼠标悬停在立方体表面，显示蓝色圆环指示器
- **边拾取**: 鼠标悬停在立方体边线，显示绿色三角箭头
- **点拾取**: 鼠标悬停在立方体顶点，显示红色方框
- **对象高亮**: 整个立方体会显示黄色线框高亮

### 状态信息
- **状态栏**: 显示拾取到的Feature类型、对象ID、本地索引
- **坐标显示**: 左下角显示精确的拾取点世界坐标

## 技术特性

### 性能优化
- **异步拾取**: 支持异步处理模式
- **双缓冲PBO**: 避免GPU-CPU同步阻塞
- **分层采样**: 中心密集采样 + 外围稀疏采样
- **频率限制**: 智能的拾取频率控制

### 精度保证
- **64位ID空间**: 支持海量对象和Feature
- **多像素采样**: 8像素半径的智能采样
- **深度优先**: 按Feature类型和深度排序选择
- **坐标精度**: 亚像素级别的坐标重建

### 扩展性
- **模块化设计**: 独立的拾取系统模块
- **可配置参数**: 支持动态调整拾取参数
- **事件驱动**: 基于回调的结果处理机制

## 代码结构

```
src/
├── PickingSystem.h/cpp          # 核心拾取系统
├── PickingIntegration.h/cpp     # 简化集成接口
├── MainWindow.h/cpp             # 集成到主窗口
└── Geo3D.h/cpp                  # 几何对象基类
```

### 核心类说明

- **PickingSystem**: 核心拾取引擎，处理FBO渲染和采样
- **SimplePickingIndicatorManager**: 指示器管理，负责显示和动画
- **PickingSystemIntegration**: 集成接口，简化使用
- **PickingEventHandler**: OSG事件处理器，捕获鼠标移动

## 配置选项

### 拾取参数
```cpp
// 设置拾取半径
osgWidget->setPickingRadius(8);  // 默认8像素

// 设置拾取频率  
osgWidget->setPickingFrequency(60.0);  // 默认60Hz

// 启用/禁用高级拾取
osgWidget->enableAdvancedPicking(true);
```

### 指示器配置
- **大小**: 可调整指示器尺寸
- **颜色**: 支持自定义颜色方案
- **动画**: 可开关动画效果

## 故障排除

### 常见问题
1. **拾取无响应**: 检查OpenGL上下文是否正确初始化
2. **指示器不显示**: 确认场景图节点添加正确
3. **性能问题**: 调整拾取频率和采样半径

### 调试模式
```cpp
// 启用调试模式
pickingSystem->setDebugMode(true);

// 导出拾取缓冲区
pickingSystem->dumpPickingBuffer("picking_debug.png");
```

## 未来扩展

### 计划功能
- [ ] 拾取结果缓存
- [ ] 更多指示器类型
- [ ] VR/AR支持
- [ ] 触摸屏支持
- [ ] 多选拾取

### API扩展
- [ ] JavaScript绑定
- [ ] Python插件接口
- [ ] 自定义着色器支持

## 许可证

本拾取系统遵循与主项目相同的许可证。 