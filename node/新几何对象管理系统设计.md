# 新几何对象管理系统设计

## 概述

本系统基于OSG节点生命周期管理Geo3D对象，使用节点名称进行类型识别，支持NodeVisitor模式访问，大大简化了之前的类型反射系统。

## 核心设计理念

### 1. Geo3D继承自osg::Group
- **优势**：几何对象本身就是OSG节点，可以直接操作场景图
- **简化**：无需额外的节点管理层，减少了代码复杂度
- **一致性**：对象的生命周期完全由OSG管理

### 2. 节点名称即类型标识
- **设计**：每个Geo3D对象的节点名称就是其几何类型名（如"Cube3D"、"Sphere3D"）
- **识别**：通过节点名称即可识别几何类型，无需复杂的类型反射
- **文件IO**：保存和加载时直接使用节点名称，兼容性更好

### 3. NodeVisitor模式访问
- **遍历**：使用标准的OSG NodeVisitor模式遍历和查找几何对象
- **性能**：利用OSG优化的场景图遍历算法
- **扩展性**：易于扩展各种查询和处理逻辑

## 核心组件

### 1. GeoTypeUtils工具类
```cpp
class GeoTypeUtils {
    static std::string geoTypeToString(GeoType3D type);
    static GeoType3D stringToGeoType(const std::string& name);
    static bool isValidGeoTypeName(const std::string& name);
    static std::vector<std::string> getAllGeoTypeNames();
};
```

### 2. Geo3DVisitor访问器
```cpp
class Geo3DVisitor : public osg::NodeVisitor {
    // 收集所有Geo3D对象
    static std::vector<osg::ref_ptr<Geo3D>> findAllGeos(osg::Node* rootNode);
    
    // 按类型查找
    static std::vector<osg::ref_ptr<Geo3D>> findGeosByType(osg::Node* rootNode, GeoType3D type);
    
    // 按名称查找
    static osg::ref_ptr<Geo3D> findGeoByName(osg::Node* rootNode, const std::string& name);
    
    // 自定义处理
    static void processAllGeos(osg::Node* rootNode, std::function<void(Geo3D*)> processor);
};
```

### 3. 场景图管理方法
```cpp
class Geo3D : public QObject, public osg::Group {
    // 场景图管理
    void setParentNode(osg::Group* parentNode);
    void removeFromParent();
    osg::Group* getParentNode() const;
    bool isInScene() const;
};
```

## 使用示例

### 1. 创建和添加几何对象
```cpp
// 创建立方体
osg::ref_ptr<Geo3D> cube = GeometryFactory::createGeometry(Geo_Cube3D);
// 节点名称自动设置为"Cube3D"

// 添加到场景
cube->setParentNode(sceneRoot);

// 或使用OSGWidget的简化接口
osgWidget->addGeo(cube);
```

### 2. 查找几何对象
```cpp
// 查找所有立方体
std::vector<osg::ref_ptr<Geo3D>> cubes = Geo3DVisitor::findGeosByType(sceneRoot, Geo_Cube3D);

// 查找特定名称的对象
osg::ref_ptr<Geo3D> myCube = Geo3DVisitor::findGeoByName(sceneRoot, "Cube3D");

// 在OSGWidget中查找
std::vector<osg::ref_ptr<Geo3D>> spheres = osgWidget->findGeosByType(Geo_Sphere3D);
```

### 3. 文件保存和加载
```cpp
// 保存：节点名称自动包含类型信息
GeoOsgbIO::saveGeoList("scene.osgb", geoList);

// 加载：根据节点名称自动识别和创建几何对象
std::vector<osg::ref_ptr<Geo3D>> loadedGeos = GeoOsgbIO::loadGeoList("scene.osgb");
```

### 4. 自定义处理
```cpp
// 处理场景中所有几何对象
Geo3DVisitor::processAllGeos(sceneRoot, [](Geo3D* geo) {
    LOG_INFO("处理几何对象: " + QString::fromStdString(geo->getName()));
    // 可以进行选择、高亮、属性修改等操作
});
```

## 优势

### 1. 简化的架构
- 移除了复杂的类型反射系统
- 减少了节点管理的中间层
- 代码更清晰易懂

### 2. 标准的OSG模式
- 完全符合OSG的设计理念
- 利用OSG的性能优化
- 易于与其他OSG代码集成

### 3. 更好的文件兼容性
- 节点名称是标准的OSG特性
- 可以被其他OSG应用程序识别
- 文件格式更加通用

### 4. 灵活的查询能力
- NodeVisitor提供强大的遍历能力
- 支持复杂的查询条件
- 易于扩展新的查询类型

## 迁移指南

### 对于现有代码
1. `geo->mm_node()->getOSGNode()` → 直接使用 `geo`
2. 类型识别通过 `geo->getName()` 或 `geo->getGeoType()`
3. 场景管理使用 `geo->setParentNode()` / `geo->removeFromParent()`

### 对于文件IO
- 新文件自动使用节点名称识别
- 旧文件仍然支持（通过兼容性代码）
- 建议重新保存旧文件以获得最佳性能

## 未来扩展

1. **性能优化**：可以使用OSG的空间索引优化查询
2. **属性查询**：扩展Visitor支持基于属性的查询
3. **批量操作**：使用Visitor模式实现高效的批量操作
4. **插件系统**：基于节点名称实现几何类型的插件化加载 